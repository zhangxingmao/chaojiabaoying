import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

// 验证环境变量
if (!process.env.OPENROUTER_API_KEY) {
  throw new Error('OPENROUTER_API_KEY environment variable is not set');
}

const openai = new OpenAI({
  baseURL: "https://openrouter.ai/api/v1",
  apiKey: process.env.OPENROUTER_API_KEY,
  defaultHeaders: {
    "HTTP-Referer": process.env.NEXT_PUBLIC_SITE_URL || "https://chaojiabaoying.com",
    "X-Title": process.env.NEXT_PUBLIC_SITE_NAME || "ChaoJiaBaoYing",
  },
});

const stylePrompts = {
  sarcastic: "用阴阳怪气、讽刺暗示的方式回击，语气带有强烈嘲讽，让对方感受到被鄙视的滋味，但保持表面的礼貌",
  logical: "用严密的逻辑和理性分析来彻底反驳，条理清晰，有理有据，让对方的观点显得愚蠢可笑",
  emotional: "用强烈的情感表达来回应，充满激情和愤怒，让对方感受到你的不满和愤慨",
  humorous: "用幽默调侃的方式嘲笑对方，轻松诙谐但暗含讽刺，让对方在笑声中感到尴尬",
  philosophical: "用深度的哲学思辨来回应，显示你的智慧深度，让对方感到自己的浅薄无知",
  direct: "直接有力地回击，简洁明了，一针见血，毫不留情地指出对方的错误",
  savage: "毫不留情的犀利回击，用最直接最有力的方式反驳，让对方哑口无言",
  witty: "机智巧妙的回击，用聪明的话术和巧妙的比喻让对方自愧不如",
  dominant: "展现强势和自信的回击，用气势压倒对方，显示你的优越感"
};

export async function POST(request: NextRequest) {
  try {
    const { opponentText, intensity, attackStyle, ultimateMode } = await request.json();

    if (!opponentText || !attackStyle || intensity < 1 || intensity > 10) {
      return NextResponse.json(
        { error: '参数不完整或无效' },
        { status: 400 }
      );
    }

    const stylePrompt = stylePrompts[attackStyle as keyof typeof stylePrompts];
    const intensityDesc = intensity <= 3 ? "温和但有力" : intensity <= 6 ? "中等强度，有明显攻击性" : intensity <= 8 ? "强烈且犀利" : "极其强烈，毫不留情";
    
    // 终极模式增强提示
    const ultimatePrompt = ultimateMode ? `

【终极回击模式已开启】
- 回击要更加犀利和解气，让对方感到强烈的挫败感
- 可以适当提高攻击性，但仍要保持智慧和逻辑
- 要让使用者感到非常痛快和解气
- 回击要有更强的震慑力和说服力
- 可以使用更加直接和有力的表达方式` : '';

    const systemPrompt = `你是一个专业的辩论大师和语言艺术家，擅长生成犀利解气的回击内容。请以${stylePrompt}的方式回击对方的话。

强度等级：${intensityDesc}（1-10级中的${intensity}级）${ultimatePrompt}

请生成5个不同的回击内容，每个回击都要：
1. 完全符合指定的风格特点，让人感到解气
2. 根据强度等级调整犀利程度，强度越高越要让对方难堪
3. 有理有据，逻辑清晰，让对方无法反驳
4. 长度控制在30-60字之间，简洁有力
5. 要有创意和新意，避免套话
6. 让使用者感到痛快和解气

对方说的话："${opponentText}"

分析对方话语的弱点，针对性地进行回击。如果对方的话有逻辑漏洞、事实错误、态度问题等，要重点攻击这些弱点。

请直接返回5个回击内容，用换行符分隔，不要添加序号或其他格式。每个回击都要让人感到解气和痛快。`;

    const completion = await openai.chat.completions.create({
      model: "deepseek/deepseek-chat",
      messages: [
        {
          role: "user",
          content: systemPrompt
        }
      ],
      temperature: ultimateMode ? 0.95 : 0.9,
      max_tokens: 800
    });

    const responseText = completion.choices[0].message.content;
    if (!responseText) {
      throw new Error('API返回内容为空');
    }

    // 将回复按行分割，过滤空行，取前5个
    const responses = responseText
      .split('\n')
      .filter(line => line.trim().length > 0)
      .slice(0, 5);

    // 如果回复少于5个，用备用回复补充
    while (responses.length < 5) {
      const fallbackResponses = generateMockResponses(opponentText, intensity, attackStyle, ultimateMode);
      responses.push(...fallbackResponses.slice(responses.length));
    }

    return NextResponse.json({ responses: responses.slice(0, 5) });

  } catch (error) {
    console.error('API Error:', error);
    return NextResponse.json(
      { error: '生成失败，请重试' },
      { status: 500 }
    );
  }
}

// 生成更犀利的模拟回击内容
function generateMockResponses(opponentText: string, intensity: number, attackStyle: string, ultimateMode: boolean): string[] {
  const normalResponses: { [key: string]: string[][] } = {
    sarcastic: [
      ["哦，这话说得真有水平呢，我差点就信了", "您这见解真是让人大开眼界，我都不知道该怎么夸您了", "这逻辑，我服了，真的服了您的想象力"],
      ["哇，您真是太厉害了，我这辈子都没见过这么有才华的人", "这话说得，我都不知道怎么接了，您真是语言大师", "您这智慧，真是深不可测，我们凡人理解不了"],
      ["您说得对，我们都错了，您就是真理的化身", "这见解，真是前无古人后无来者，诺贝尔奖都配不上您", "我被您的才华震撼到了，请收下我的膝盖"]
    ],
    logical: [
      ["您的观点缺乏基本的事实依据，建议先做功课再发言", "这个结论漏洞百出，需要重新学习基础逻辑", "您的推理过程存在严重的逻辑谬误"],
      ["数据和事实都证明您说错了，请面对现实", "您的论证过程有致命缺陷，站不住脚", "事实胜于雄辩，而您连事实都搞错了"],
      ["请提供可靠的证据来源，而不是凭空想象", "这种说法完全站不住脚，毫无说服力", "理性分析一下就知道您的观点有多荒谬"]
    ],
    emotional: [
      ["这话真的很过分！您这是在侮辱我的智商吗？", "我不能接受这种无理的指责！", "这太让人愤怒了！您凭什么这样说？"],
      ["您这样说让我非常失望和愤怒", "我真的很难过，没想到您是这样的人", "这种话太让人心寒了，我对您彻底失望"],
      ["我为您的无知感到震惊", "这真的让我很愤怒，您太过分了", "我无法理解您怎么能说出这种话"]
    ],
    humorous: [
      ["哈哈，您这是在说相声吗？我差点笑出声来", "这话比段子还精彩，您应该去德云社", "您这幽默感，我服了，真的服了"],
      ["我差点被您逗笑了，这创意真是绝了", "这想法真有创意，给您满分", "您这脑洞，我都不知道该怎么夸了"],
      ["这话说得，我都想给您鼓掌了", "您这是在逗我玩吗？太有意思了", "这想象力，真是丰富得让人佩服"]
    ],
    philosophical: [
      ["存在即合理，但您的观点既不存在也不合理", "真理往往掌握在少数人手中，很遗憾您不在其中", "智者千虑必有一失，但您是千虑千失"],
      ["凡事都有两面性，但您只看到了错误的那一面", "真相往往比表象复杂，而您连表象都没看清", "思考的深度决定认知的高度，您的高度令人担忧"],
      ["知识的边界就是无知的开始，您已经越过了边界", "质疑是智慧的开端，但您质疑错了方向", "真理不辩不明，但您连辩论的资格都没有"]
    ],
    direct: [
      ["您说错了，而且错得离谱", "这完全不对，您需要重新学习", "我坚决不同意您的无理观点"],
      ["事实不是这样的，您的信息完全错误", "您的推理过程有严重问题", "这个观点根本站不住脚"],
      ["我必须纠正您的错误认知", "这是完全错误的理解", "您需要重新了解一下基本常识"]
    ],
    savage: [
      ["您这话说得，我都替您感到尴尬", "这水平，我建议您还是别说话了", "您这智商，真的不适合参与讨论"],
      ["说实话，您这话让我怀疑您的基本素养", "这种观点，只有您这样的人才说得出来", "您这逻辑，我都不知道该从哪里开始吐槽"],
      ["您这话，暴露了您的无知和浅薄", "这种言论，真的很丢人", "您这水平，还是回去多读点书吧"]
    ],
    witty: [
      ["您这话说得，就像是在证明达克效应的存在", "这逻辑，比莫比乌斯环还要扭曲", "您这观点，成功地刷新了我对无知的认知下限"],
      ["这话说得，就像是在用事实证明自己的错误", "您这推理，比量子力学还要难以理解", "这见解，成功地让我见识了什么叫做反向思维"],
      ["您这话，完美地诠释了什么叫做自相矛盾", "这逻辑，比薛定谔的猫还要神奇", "您这观点，成功地让我怀疑了物理定律"]
    ],
    dominant: [
      ["您这水平，还是别在这里丢人现眼了", "这种话，也就您说得出来", "您这见识，真的配不上这个话题"],
      ["说实话，您根本不配和我讨论这个问题", "您这水平，我都不知道该怎么和您解释", "这种观点，只能说明您的层次太低"],
      ["您这话，暴露了您和我们之间的差距", "这种理解，真的很幼稚", "您这水平，还是先提升一下自己再来吧"]
    ]
  };

  // 终极模式的更犀利回击
  const ultimateResponses: { [key: string]: string[][] } = {
    sarcastic: [
      ["哦，这话说得真是惊天地泣鬼神，我都被您的智慧震撼得说不出话了", "您这见解真是让人叹为观止，我怀疑您是不是来自外星球", "这逻辑，我不仅服了，我还想给您颁个奖"],
      ["哇，您真是当代爱因斯坦，我这辈子都没见过这么有才华的天才", "这话说得，我都怀疑自己的智商是不是有问题", "您这智慧，已经超越了人类的理解范围"],
      ["您说得太对了，我们这些凡人怎么能理解您的高深思想", "这见解，足以改写人类历史，您应该去拿诺贝尔奖", "我被您的才华彻底征服了，请允许我膜拜您"]
    ],
    logical: [
      ["您的观点不仅缺乏事实依据，简直是在挑战基本常识", "这个结论的漏洞大到可以开卡车，建议您重新学习小学逻辑", "您的推理过程存在致命缺陷，完全站不住脚"],
      ["所有数据和事实都在打您的脸，请睁开眼睛看看现实", "您的论证过程漏洞百出，毫无说服力", "事实胜于雄辩，而您连最基本的事实都搞错了"],
      ["请提供任何一个可靠的证据，而不是在这里胡说八道", "这种说法完全是无稽之谈，没有任何价值", "稍微动动脑子就知道您的观点有多么荒谬可笑"]
    ],
    emotional: [
      ["这话真的太过分了！您这是在公然侮辱所有人的智商！", "我绝对不能容忍这种无理取闹的胡言乱语！", "这太让人愤怒了！您凭什么说出这种话？"],
      ["您这样说让我感到极度愤怒和失望", "我真的很震惊，没想到您能说出这种话", "这种言论太让人心寒了，我对您彻底绝望"],
      ["我为您的无知和傲慢感到震惊", "这真的让我怒火中烧，您太过分了", "我无法理解您怎么能厚颜无耻地说出这种话"]
    ],
    humorous: [
      ["哈哈，您这是在表演单口相声吗？我快笑死了", "这话比最搞笑的段子还精彩，您应该去当喜剧演员", "您这幽默天赋，我真的佩服得五体投地"],
      ["我差点被您逗得笑岔气了，这创意绝对是天才级别", "这想法太有创意了，我给您打满分", "您这脑洞，已经大到可以装下整个宇宙了"],
      ["这话说得，我都想给您颁发最佳喜剧奖了", "您这是在逗我玩吗？太有才了", "这想象力，已经超越了人类的极限"]
    ],
    philosophical: [
      ["存在即合理，但您的观点既不存在也不合理，完全是虚无缥缈", "真理往往掌握在少数人手中，很遗憾您连边都沾不上", "智者千虑必有一失，但您是千虑千失万失"],
      ["凡事都有两面性，但您只看到了错误的那一面，而且看得还不清楚", "真相往往比表象复杂，而您连最简单的表象都理解错了", "思考的深度决定认知的高度，您的高度已经是负数了"],
      ["知识的边界就是无知的开始，您已经彻底迷失在无知的深渊中", "质疑是智慧的开端，但您质疑错了所有方向", "真理不辩不明，但您连参与辩论的基本资格都没有"]
    ],
    direct: [
      ["您说错了，而且错得彻底离谱，毫无道理", "这完全是胡说八道，您需要从头开始学习", "我坚决反对您这种毫无根据的无理观点"],
      ["事实完全不是这样的，您的信息错得一塌糊涂", "您的推理过程有严重的致命缺陷", "这个观点根本就是无稽之谈，完全站不住脚"],
      ["我必须严厉纠正您这种错误的认知", "这是彻底错误的理解，毫无价值", "您需要重新学习最基本的常识和逻辑"]
    ],
    savage: [
      ["您这话说得，我都替您感到深深的羞耻", "这水平，我强烈建议您永远别再开口说话", "您这智商，真的完全不适合参与任何讨论"],
      ["说实话，您这话让我严重怀疑您的基本素养和教育水平", "这种观点，只有您这种层次的人才能说得出来", "您这逻辑，我都不知道该从哪里开始吐槽这个灾难"],
      ["您这话，彻底暴露了您的无知、浅薄和愚蠢", "这种言论，真的是丢人现眼到了极点", "您这水平，还是回去从小学开始重新读书吧"]
    ],
    witty: [
      ["您这话说得，简直是在为达克效应提供完美的案例研究", "这逻辑，比四维空间的莫比乌斯环还要扭曲", "您这观点，成功地将人类对无知的认知推向了新的深度"],
      ["这话说得，就像是在用实际行动证明自己的错误有多么彻底", "您这推理，比量子纠缠还要难以理解和接受", "这见解，成功地让我见识了什么叫做反向进化"],
      ["您这话，完美地演示了什么叫做逻辑的全面崩塌", "这逻辑，比平行宇宙中的薛定谔的猫还要神奇", "您这观点，成功地让我开始怀疑整个物理学定律"]
    ],
    dominant: [
      ["您这水平，真的不配在这里浪费大家的时间", "这种话，也就您这种层次的人才说得出来", "您这见识，完全配不上参与这个话题的资格"],
      ["说实话，您根本没有资格和我们讨论这个问题", "您这水平，我都懒得解释给您听", "这种观点，只能说明您的层次低得令人发指"],
      ["您这话，彻底暴露了您和正常人之间的巨大差距", "这种理解，幼稚得让人无法直视", "您这水平，还是先回去提升个几十年再来吧"]
    ]
  };

  const responses = ultimateMode ? ultimateResponses : normalResponses;
  const styleResponses = responses[attackStyle] || responses.direct;
  const intensityIndex = Math.min(Math.floor((intensity - 1) / 3), 2);
  
  return styleResponses[intensityIndex] || styleResponses[0];
} 